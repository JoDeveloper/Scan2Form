<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan2Form Example</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .container { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        .status { margin-top: 10px; color: #666; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        #preview { margin-top: 20px; border: 1px dashed #aaa; padding: 10px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scan directly to Form</h1>
        <p>Ensure <b>naps2.console</b> is installed and <b>npx scan2form-server</b> is running.</p>
        
        <!-- The form we want to populate -->
        <form id="my-form" action="#" onsubmit="alert('Form submitted with file!'); return false;">
            
            <div style="margin-bottom: 20px;">
                <label><b>Scan Mode:</b></label>
                <label><input type="radio" name="mode" value="application/pdf" checked onchange="updateMode(this.value)"> Document (PDF)</label>
                <label><input type="radio" name="mode" value="image/jpeg" onchange="updateMode(this.value)"> Photo (JPEG)</label>
            </div>

            <label for="document-upload">Target Input:</label>
            <!-- Standard file input (Hidden) -->
            <!-- We set accept="application/pdf" by default -->
            <input type="file" id="document-upload" name="document" accept="application/pdf" required style="display: none;" />
            <div id="file-display">No file scanned yet.</div>
            <br><br>
            
            <label style="display:inline-flex; align-items:center; margin-bottom: 10px; color: #555;">
                <input type="checkbox" id="mock-check"> &nbsp; Simulate Scan (Test Mode)
            </label>
            <br>
            <button type="button" id="scan-btn">üñ®Ô∏è Scan from Device</button>
            <button type="submit">Submit Form</button>
        </form>

        <div id="status" class="status"></div>
        
        <div id="preview">
            <h3>Preview:</h3>
            <div id="preview-container">
                <!-- Preview elements will be auto-populated by the library -->
                <img id="preview-img" style="max-width: 100%; display: none;" />
                <iframe id="preview-frame" style="width: 100%; height: 500px; display: none; border: 1px solid #ccc;"></iframe>
            </div>
            <div>File attached: <span id="filename"></span></div>
        </div>
    </div>

    
    <script type="module">
        // In a real app, this would be: import { Scan2Form } from 'scan2form';
        
        import { Scan2Form } from '../dist/esm/scanner-client.js';

        const scanner = new Scan2Form();
        const statusDiv = document.getElementById('status');
        const previewDiv = document.getElementById('preview');
        const filenameSpan = document.getElementById('filename');
        const fileInput = document.getElementById('document-upload');

        // Helper to switch input mode
        window.updateMode = (mimeType) => {
            fileInput.accept = mimeType;
            console.log("Input accept set to:", mimeType);
        }

        // Update display when input changes
        fileInput.addEventListener('change', () => {
             const display = document.getElementById('file-display');
             if (fileInput.files.length > 0) {
                 display.innerText = "üìÅ File Ready: " + fileInput.files[0].name;
                 display.style.color = 'green';
                 display.style.fontWeight = 'bold';
             } else {
                 display.innerText = "No file scanned yet.";
                 display.style.color = 'inherit';
                 display.style.fontWeight = 'normal';
             }
        });

        // Check if bridge is online
        (async () => {
            const online = await scanner.isAvailable();
            if(online) {
                statusDiv.innerText = "‚úÖ Bridge Connected";
                statusDiv.classList.add('success');
                
                // List devices
                const result = await scanner.getDevices();
                
                if (result.error) {
                    const msg = document.createElement('div');
                    msg.innerHTML = `‚ö†Ô∏è <b>Error:</b> ${result.error}`;
                    msg.style.color = 'red';
                    msg.style.backgroundColor = '#ffe6e6';
                    msg.style.padding = '10px';
                    msg.style.marginTop = '10px';
                    msg.style.borderRadius = '5px';
                    statusDiv.appendChild(msg);
                } else if(result.devices.length > 0) {
                     const deviceList = document.createElement('ul');
                     result.devices.forEach(d => {
                         const li = document.createElement('li');
                         li.innerText = d;
                         deviceList.appendChild(li);
                     });
                     statusDiv.appendChild(document.createElement('hr'));
                     statusDiv.appendChild(document.createTextNode("Available Scanners:"));
                     statusDiv.appendChild(deviceList);
                } else {
                    const msg = document.createElement('div');
                    msg.innerText = "No scanners connected.";
                    msg.style.color = 'orange';
                    statusDiv.appendChild(msg);
                }

            } else {
                statusDiv.innerText = "‚ùå Bridge Offline (Run 'npx scan2form-server')";
                statusDiv.classList.add('error');
            }
        })();

        document.getElementById('scan-btn').addEventListener('click', async () => {
            const useMock = document.getElementById('mock-check').checked;
            statusDiv.innerText = useMock ? "Simulating Scan..." : "‚è≥ Scanning...";
            statusDiv.className = 'status'; // reset colors
            
            // Reset previews
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('preview-frame').style.display = 'none';

            // Determine preview intent
            const isImage = fileInput.accept.includes('image');
            const targetPreviewId = isImage ? 'preview-img' : 'preview-frame';

            let result;
            try {
                if (useMock) {
                    // Mock Flow
                    await new Promise(r => setTimeout(r, 1000)); // Fake delay
                    
                    if (!fileInput.accept) throw new Error("Input accept attribute missing");
                    
                    const mockFile = await createMockFile(fileInput.accept);
                    result = { success: true, file: mockFile };
                    
                    // Manually populate input for mock
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(mockFile);
                    fileInput.files = dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change', { bubbles: true }));

                    // Manually trigger preview for mock
                    const url = URL.createObjectURL(mockFile);
                    const el = document.getElementById(targetPreviewId);
                    el.src = url;

                } else {
                    // Real Flow
                    // Reverted client only has scanToInput(inputId)
                    result = await scanner.scanToInput('document-upload');
                }
            } catch (err) {
                console.error("Scan/Mock Error:", err);
                result = { success: false, error: err };
            }

            if (result.success) {
                statusDiv.innerText = useMock ? "‚úÖ Simulation Success!" : "‚úÖ Scan Success!";
                statusDiv.classList.add('success');
                previewDiv.style.display = 'block';
                filenameSpan.innerText = result.file.name + ` (${Math.round(result.file.size/1024)} KB)`;
                
                // Manually handle preview (required for reverted client)
                const url = URL.createObjectURL(result.file);
                const el = document.getElementById(targetPreviewId);
                el.src = url;

                document.getElementById(targetPreviewId).style.display = 'block';
                
            } else {
                const errMsg = result.error.message || result.error || "Unknown error";
                statusDiv.innerText = "‚ùå Scan Failed: " + errMsg;
                statusDiv.classList.add('error');
            }
        });

        // Mock File Generator
        async function createMockFile(accept) {
            const isPdf = accept.includes('pdf');
            if (isPdf) {
                // Minimal valid PDF binary
                const pdfBase64 = "JVBERi0xLjQKMSAwIG9iago8PC9UeXBlIC9DYXRhbG9nCi9QYWdlcyAyIDAgUgo+PgplbmRvYmoK MiAwIG9iago8PC9UeXBlIC9QYWdlcwovS2lkcyBbMyAwIFJdCi9Db3VudCAxCj4+CmVuZG9iagoz IDAgb2JqCjw8L1R5cGUgL1BhZ2UKL1BhcmVudCAyIDAgUgovTWVkaWFCb3ggWzAgMCA1OTUgODQy XQovQ29udGVudHMgNSAwIFIKL1Jlc291cmNlcyA8PC9Qcm9jU2V0IFsvUERGIC9UZXh0XQovRm9u dCA8PC9GMSA0IDAgUj4+Cj4+Cj4+CmVuZG9iago0IDAgb2JqCjw8L1R5cGUgL0ZvbnQKL1N1YnR5 cGUgL1R5cGUxCi9OYW1lIC9GMQovQmFzZUZvbnQgL0hlbHZldGljYQovRW5jb2RpbmcgL01hY1Jv bWFuRW5jb2RpbmcKPj4KZW5kb2JqCjUgMCBvYmoKPDwvTGVuZ3RoIDUzCj4+CnN0cmVhbQpCVAov RjEgMjAgVGYKMjIwIDQwMCBUZAooRHVtbXkgUERGKSBUagpFVAplbmRzdHJlYW0KZW5kb2JqCnhy ZWYKMCA2CjAwMDAwMDAwMDAgNjU1MzUgZgowMDAwMDAwMDA5IDAwMDAwIG4KMDAwMDAwMDA2MyAw MDAwMCBuCjAwMDAwMDAxMjQgMDAwMDAgbgowMDAwMDAwMjc3IDAwMDAwIG4KMDAwMDAwMDM5MiAw MDAwMCBuCnRyYWlsZXIKPDwvU2l6ZSA2Ci9Sb290IDEgMCBSCj4+CnN0YXJ0eHJlZgo0OTUKJSVF T0YK";
                const blob = await (await fetch(`data:application/pdf;base64,${pdfBase64}`)).blob();
                return new File([blob], "mock_scan.pdf", { type: "application/pdf" });
            } else {
                // 1x1 Pixel Red Dot (PNG)
                const pngBase64 = "iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAADMElEQVR4nOzVwQnAIBQFQYXff81RUkQCOyDj1YOPnbXWPmeTRef+/3O/OyBjzh3CD95BfqICMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMK0CMO0TAAD";
                const blob = await (await fetch(`data:image/png;base64,${pngBase64}`)).blob();
                return new File([blob], "mock_scan.png", { type: "image/png" });
            }
        }
    </script>
</body>
</html>
